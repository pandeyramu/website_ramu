{% load static %}
{% load quiz_extra %}
<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <title>{{ chapter.name }} Quiz | CEE Chapter-wise Practice</title>
    <meta name="description" content="Take the {{ chapter.name }} quiz for the Common Entrance Examination. Practice chapter-wise questions and track your performance with detailed results.">
    <meta name="keywords" content="CEE Quiz, {{ chapter.name }} Quiz, Chapter-wise Questions, Online Practice, Pandey Ramu">
    <meta name="author" content="Pandey Ramu">

    <!-- Open Graph / Social Preview -->
    <meta property="og:title" content="{{ chapter.name }} Quiz | CEE Chapter-wise Practice">
    <meta property="og:description" content="Take the {{ chapter.name }} quiz for the Common Entrance Examination. Practice chapter-wise questions and track your performance with detailed results.">
    <meta property="og:type" content="website">
    <meta property="og:url" content="{{ request.build_absolute_uri }}">
    <meta property="og:image" content="{% static 'images/favicon.png' %}">

    <!-- Twitter Card -->
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:title" content="{{ chapter.name }} Quiz">
    <meta name="twitter:description" content="Practice {{ chapter.name }} quiz questions online and improve your CEE preparation.">
    <meta name="twitter:image" content="{% static 'images/favicon.png' %}">

    <link rel="stylesheet" href="{% static 'css/style.css' %}">
    <link rel="icon" href="{% static 'images/favicon.png'}" type="image/png">
</head>

<body>
    <header>
        <div class="container">
            <h1>{{ chapter.name }} Quiz</h1>
            <p>Test your knowledge of {{ chapter.name }} with chapter-wise questions and track your score.</p>
        </div>
    </header>

    <main class="container">
        {% if questions %}
            {% if not quiz_started and score is None %}
            <form method="get" class="start-form">
                <input type="text" name="name" class="name_place" placeholder="Enter your name" required>
                <button type="submit" name="start" value="1" id="start_btn" class="start_test">Start Quiz</button>
            </form>
            <div id="timer" style="display: none;"></div>
            {% endif %}

            <form method="POST" class="quiz-form {% if score is not None %}submitted{% endif %}" action="{% url 'quiz' chapter.id %}" id="quiz-form"
                {% if not quiz_started and score is None %}style="display: none;"{% else %}style="display: block;"{% endif %}>
                {% csrf_token %}
                <input type="hidden" name="name" id="hidden-name" value="{{ request.GET.name|default:'' }}">

                {% for q in questions %}
                <article class="question-block">
                    <p><strong>{{ forloop.counter }}. {{ q.question_text }}</strong></p>
                    {% for opt in "ABCD" %}
                        {% with option_text=q|get_option_text:opt %}
                        {% with user_choice=user_answers|dict_get:q.id %}
                        <label class="option
                            {% if score is not None %}
                                {% if opt == q.correct_option %} correct {% endif %}
                                {% if user_choice|default:'' == opt and opt != q.correct_option %} wrong {% endif %}
                            {% endif %}
                            {% if user_choice|default:'' == opt %} selected {% endif %}">
                            <input type="radio" name="q{{ q.id }}" value="{{ opt }}" 
                                   {% if score is not None %} disabled {% endif %} 
                                   {% if user_choice|default:'' == opt %} checked {% endif %}>
                            <span class="option-text">{{ opt }}. {{ option_text }}</span>
                        </label>
                        {% endwith %}
                        {% endwith %}
                    {% endfor %}
                </article>
                {% endfor %}

                {% if score is None %}
                    <button type="submit" class="submit-btn">Submit Quiz</button>
                {% else %}
                    <section class="score-card">
                        <h2 class="score-title">Quiz Results</h2>
                        <div class="score-stats">
                            <div class="stat-item">
                                <span class="stat-label">Total Questions:</span>
                                <span class="stat-value">{{ total_questions }}</span>
                            </div>
                            <div class="stat-item">
                                <span class="stat-label">Attempted:</span>
                                <span class="stat-value">{{ total_attempted }}</span>
                            </div>
                            <div class="stat-item correct">
                                <span class="stat-label">Correct:</span>
                                <span class="stat-value">{{ total_correct }}</span>
                            </div>
                            <div class="stat-item wrong">
                                <span class="stat-label">Wrong:</span>
                                <span class="stat-value">{{ total_wrong }}</span>
                            </div>
                            <div class="stat-item skipped">
                                <span class="stat-label">Skipped:</span>
                                <span class="stat-value">{{ total_skipped }}</span>
                            </div>
                            <div class="stat-item final-score">
                                <span class="stat-label">Final Score:</span>
                                <span class="stat-value">{{ score }} / {{ total_questions }}</span>
                            </div>
                        </div>
                        <p class="negative-marking-note">* Negative marking of 0.25 applied per wrong answer</p>
                    </section>
                {% endif %}
            </form>
        {% else %}
            <p class="no-questions">No questions available for this chapter.</p>
        {% endif %}

        <nav class="links">
            {% if questions %}
                {% if score is not None or quiz_started %}
                    <a href="{% url 'quiz' chapter.id %}" class="go_back">Retry Quiz</a>
                {% endif %}
            {% endif %}
            <a href="{% url 'chapters' chapter.subject.id %}" class="back-chapters">Back to Chapters</a>
            <a href="{% url 'home' %}" class="back-subjects">Back to Subjects</a>
        </nav>
    </main>

    <footer class="container">
        <p>&copy; 2026 Ramu Pandey. All Rights Reserved.</p>
    </footer>

    <script src="{% static 'js/style.js' %}"></script>
</body>

</html>
